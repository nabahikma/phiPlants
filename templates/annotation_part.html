<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Annotation Step</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
  <style>
    :root { --bg:#e6f3f5; --btn:#007bff; --btn-hover:#0056b3; --border:#ddd; --text:#111; }
    * { box-sizing:border-box; }
    body, html { margin:0; padding:0; height:100%; font-family:Arial, sans-serif; color:var(--text); }
    .container { display:flex; height:100%; }
    .left-half { flex:1; background-image:url('/static/lefthalf.jpeg'); background-size:cover; background-position:center; }
    .right-half { flex:1; background-color:var(--bg); display:flex; flex-direction:column; justify-content:center; align-items:center; padding:40px; }
    h2 { margin:0 0 10px 0; }
    .card { width:100%; max-width:720px; background:white; border:1px solid var(--border); border-radius:16px; padding:22px; }
    .pill { display:inline-block; padding:6px 12px; border-radius:20px; background:#f8f8f8; border:1px solid var(--border); margin:0 8px 12px 0; font-size:14px; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input[type="text"], input[type="number"] { width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:12px; font-size:16px; outline:none; }
    .submit-btn { background:var(--btn); color:white; border:none; padding:14px; border-radius:22px; font-size:16px; cursor:pointer; width:100%; margin-top:16px; }
    .submit-btn:hover { background:var(--btn-hover); }
    #logs { font-family: monospace; height: 320px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px; white-space: pre-wrap; margin-top:12px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-half"></div>
    <div class="right-half">
      <h2>Annotation</h2>
      <div class="card">
        <!-- Show only Directory, hide the rest -->
        <div class="pill">Directory: <strong>{{ directory }}</strong></div>

        <!-- Hidden fields -->
        <input type="hidden" id="directory" value="{{ directory }}">
        <input type="hidden" id="polarity"  value="{{ polarity }}">
        <input type="hidden" id="table"     value="{{ table }}">

        <p>We‚Äôll annotate your Features Matrix using CAMERA adducts/isotopes and Rdisop-generated formulas, then match to your local DB (and optional Analyte List).</p>

        <label for="analyte_csv">(Optional) Analyte List CSV (must include MolecularFormula, ExactMass, CompoundName)</label>
        <input type="text" id="analyte_csv" placeholder="C:\path\to\AnalyteList.csv">

        <button id="runBtn" class="submit-btn">Start Annotation üß™</button>

        <div id="logs"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const btn  = $("runBtn");
  const logs = $("logs");

  btn.addEventListener("click", async () => {
    const directory = $("directory").value;
    const polarity  = $("polarity").value;
    const table     = $("table").value;
    const analyte_csv = $("analyte_csv").value.trim() || null;

    logs.style.display = "block";
    logs.textContent = "Annotation in processing...\n";

    const payload = { directory, polarity, table, analyte_csv };

    btn.disabled = true;

    try {
      const resp = await fetch("/annotate/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.body) {
        logs.textContent += "‚ùå Failed to start annotation.\n";
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let tail = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        logs.textContent += chunk;
        logs.scrollTop = logs.scrollHeight;

        tail = (tail + chunk).slice(-500);
        const m = tail.match(/__ANNOT_DONE__\s+EXIT_CODE=(\d+)/);
        if (m) {
          const code = Number(m[1]);
          if (code === 0) {
            // Redirect to ShowTable
            const q = new URLSearchParams({
              directory: directory,
              file: "Features_Matrix_Annotated.csv"
            });
            window.location.assign(`/ShowTable?${q.toString()}`);
          } else {
            logs.textContent += "\n‚ùå Annotation failed. See logs above.\n";
          }
          break;
        }
      }
    } catch (e) {
      logs.textContent += "\n‚ùå " + (e?.message || e);
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>