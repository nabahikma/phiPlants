<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Processing XCMS</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
  <style>
    :root { --bg:#e6f3f5; --btn:#007bff; --btn-hover:#0056b3; --border:#ddd; --text:#111; }
    * { box-sizing:border-box; }
    body, html { margin:0; padding:0; height:100%; font-family:Arial, sans-serif; color:var(--text); }
    .container { display:flex; height:100%; }
    .left-half { flex:1; background-image:url('/static/lefthalf.jpeg'); background-size:cover; background-position:center; }
    .right-half { flex:1; background-color:var(--bg); display:flex; flex-direction:column; justify-content:center; align-items:center; padding:40px; }
    h2 { margin:0 0 6px 0; }
    h4 { margin:0 0 18px 0; font-weight:500; }
    .form-container { width:100%; max-width:520px; background:white; border:1px solid var(--border); border-radius:16px; padding:20px; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input[type="text"], input[type="number"] { width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:12px; font-size:16px; outline:none; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .submit-btn { background:var(--btn); color:white; border:none; padding:14px; border-radius:22px; font-size:16px; cursor:pointer; width:100%; margin-top:16px; }
    .submit-btn:hover { background:var(--btn-hover); }
    .pill { display:inline-block; padding:6px 12px; border-radius:20px; background:#f8f8f8; border:1px solid var(--border); margin:0 8px 12px 0; font-size:14px; }
    #status { font-family: monospace; height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px; white-space: pre-wrap; }
    .note { font-size:13px; color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-half"></div>

    <div class="right-half">
      <h2>The Converting is Done âœ…</h2>
      <h4>Letâ€™s apply The Algorithms on your data</h4>

      <div class="form-container">
        <div class="pill">Directory: <strong>{{ directory }}</strong></div>
        <div class="pill">Polarity: <strong>{{ polarity }}</strong></div>

        <form id="xcmsForm">
          <!-- Hidden fixed values -->
          <input type="hidden" id="directory" value="{{ directory }}">
          <input type="hidden" id="polarity" value="{{ polarity }}">
          <input type="hidden" id="outputName" value="Features_Matrix">

          <div class="row">
            <div>
              <label for="ppm">ppm</label>
              <input type="number" id="ppm" step="1" min="1" value="5">
            </div>
            <div>
              <label for="snr">S/N Ratio</label>
              <input type="number" id="snr" step="1" min="1" value="10">
            </div>
            <div>
              <label for="noise">Noise Level</label>
              <input type="number" id="noise" step="10" min="0" value="30">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="min_peakwidth">Min peakwidth (s)</label>
              <input type="number" id="min_peakwidth" step="1" min="2" value="4">
            </div>
            <div>
              <label for="max_peakwidth">Max peakwidth (s)</label>
              <input type="number" id="max_peakwidth" step="1" min="4" value="40">
            </div>
          </div>

          <button type="submit" id="submitBtn" class="submit-btn">Start Processing ðŸ§ª</button>
        </form>

        <p id="status"></p>
      </div>
    </div>
  </div>
</body>

<script>
  document.getElementById("xcmsForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = document.getElementById("submitBtn");
    const status = document.getElementById("status");

    const valNum = (id, def) => {
      const v = parseFloat(document.getElementById(id).value);
      return Number.isFinite(v) ? v : def;
    };

    const payload = {
      output_name: "Features_Matrix", // fixed name
      directory: document.getElementById("directory").value,
      polarity: document.getElementById("polarity").value,
      ppm: valNum("ppm", 5),
      snr: valNum("snr", 10),
      noise: valNum("noise", 30),
      min_peakwidth: valNum("min_peakwidth", 4),
      max_peakwidth: valNum("max_peakwidth", 40)
      // mzdiff fixed in R
    };

    if (payload.max_peakwidth <= payload.min_peakwidth) {
      status.textContent = "âŒ Max peakwidth must be greater than min peakwidth.";
      return;
    }

    btn.disabled = true;
    status.textContent = "";

    try {
      const resp = await fetch("/xcms/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.body) {
        status.textContent = "Failed to start XCMS.";
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let tailBuffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        status.textContent += chunk;
        status.scrollTop = status.scrollHeight;

        tailBuffer = (tailBuffer + chunk).slice(-300);
        const m = tailBuffer.match(/__XCMS_DONE__\s+EXIT_CODE=(\d+)/);
        if (m) {
          const exitCode = Number(m[1]);
          if (exitCode === 0) {
            status.textContent += "\nâœ… Success. Redirectingâ€¦\n";
            const q = new URLSearchParams({
              directory: payload.directory,
              polarity: payload.polarity,
              table: payload.output_name
            });
            window.location.href = `/annotation_part?${q.toString()}`;
          } else {
            status.textContent += `\nâŒ XCMS failed (exit ${exitCode}). Check logs above.\n`;
          }
          break;
        }
      }
    } catch (err) {
      status.textContent += "\nâŒ Network/Server error: " + (err?.message || err);
    } finally {
      btn.disabled = false;
    }
  });
</script>
</html>
